# API 接口开放平台

[项目地址](https://gitee.com/NingWest/api-interface-open-platform.git)



背景：

1. 前端开发需要用到后端接口
2. 要用现成的接口



做一个API接口平台：

1. 防止攻击（安全性）
2. 不能随便调用（限制、开通）
3. 调用次数
4. 计费
5. 流量保护
6. API接入



## 项目介绍

做一个提供API接口调用的平台，用户可以注册登录，开通接口调用权限。用户可以使用接口，并且每次调用会进行统计。管理员可以发布接口、下线接口、接入接口，以及可视化接口的调用情况、数据。



> x项目流程图

<img src="文档.assets/image-20230501171825813.png" alt="image-20230501171825813" style="zoom:80%;" />





## 技术选型



### 前端

Ant Design Pro

React

Ant Design Procomponents

Umi

Umi Requset (Axios 的封装)



### 后端

java Spring boot

Spring Boot Starter (SDK 开发)

？？？（网关、限流、日志实现）









## 项目分期



### 第一期 - 初始化和展示

项目介绍、设计、技术选型

基础项目的搭建

接口管理

用户查看接口

### 第二期 - 接口调用

接口调用

接口文档展示、接口在线调用

保障调用的安全性（API签名认证）

客户端SDK的开发



### 第三期 - 接口计费与保护

统计用户调用次数

限流

计费

日志

开通



### 第四期 - 管理、统计分析

提供可视化平台，用图表的方式展示所有的接口的调用情况，便于调整业务。





## Antd Pro 框架操作

### 框架安装

```bash
npm i @ant-design/pro-cli -g
```

### 项目搭建

```bash
pro create 项目名称
```



### 移除国际化报错

> 错误一

```bash
// 报错 prettier
npm i eslint prettier-eslint eslint-config-prettier --save-dev
```



> 错误二

![image-20230502073449525](文档.assets/image-20230502073449525.png)



解决办法

[解决博客](https://blog.csdn.net/weixin_42425305/article/details/129445415?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-129445415-blog-109546000.235%5Ev32%5Epc_relevant_default_base3&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-129445415-blog-109546000.235%5Ev32%5Epc_relevant_default_base3)

![image-20230502074438076](文档.assets/image-20230502074438076.png)



```bash
npm i @typescript-eslint/eslint-plugin
npm i eslint-plugin-eslint-comments
npm i eslint-plugin-jest
npm i eslint-plugin-unicorn
```



<font color=red>成功解决</font>

解决后将原本的i18n目录删除  注意 看下面保存一下这个文件



#### 国际化遗留问题

![image-20230504065451009](文档.assets/image-20230504065451009.png)



可以将这个汉语的文件添加回来

![image-20230504070743083](文档.assets/image-20230504070743083.png)











### Antd 快速与后端增删改查对应

对应后端的 openApi 的地址接口，自动生成

<img src="文档.assets/image-20230504060919671.png" alt="image-20230504060919671" style="zoom:80%;" />



> 点击即可生成代码

![image-20230504061444106](文档.assets/image-20230504061444106.png)



注意：后端的controller上不要有  @Api(tags = "微信公众号相关接口")  注解  ，前端生成代码的文件名会显示这里面汉字的拼音。。。





### Antd 修改请求的配置

![image-20230504062240347](文档.assets/image-20230504062240347.png)



将原本的 requestErrorConfig 修改为 requestConfig 

![image-20230504062317774](文档.assets/image-20230504062317774.png)



在requestConfig中添加 基础地址



### 修改Antd框架的登录接口



> 登录逻辑修改

```tsx
const handleSubmit = async (values: API.UserLoginRequest) => {
    try {
      // 登录  修改为自己后端的登录接口
      const res = await userLoginUsingPOST({ ...values });
      if (res.data) {
        const urlParams = new URL(window.location.href).searchParams;
        history.push(urlParams.get('redirect') || '/');
        return;
      }
      // 如果失败去设置用户错误信息
      setUserLoginState(msg);
    } catch (error) {
      const defaultLoginFailureMessage = intl.formatMessage({
        id: 'pages.login.failure',
        defaultMessage: '登录失败，请重试！',
      });
      console.log(error);
      message.error(defaultLoginFailureMessage);
    }
  };
```



注意：将项目中的所有 的登录对应的参数都要换成自己的，例如登录参数的接受实体信息，antd框架的登录信息是 username，password，我们自己的是userAccount，userPassword，都要修改。



> 修改完毕之后登录即可使用，但是因为没有保存用户的登录态，还是无法进入信息页面

![image-20230504065055395](文档.assets/image-20230504065055395.png)





### Antd 保存用户的登录态



> 保存信息的方法

<img src="文档.assets/image-20230504071656686.png" alt="image-20230504071656686" style="zoom:80%;" />



> 保存信息的类型

![image-20230504071957439](文档.assets/image-20230504071957439.png)



> 登录完毕之后保存用户的登录信息

```tsx
  const handleSubmit = async (values: API.UserLoginRequest) => {
    try {
      // 登录  修改为自己后端的登录接口
      const res = await userLoginUsingPOST({ ...values });
      if (res.data) {
        const urlParams = new URL(window.location.href).searchParams;
        history.push(urlParams.get('redirect') || '/');
        // 登录  ------------------
        setInitialState({
          loginUser: res.data,
        });
        // -----------------------
        return;
      }
    } catch (error) {
      const defaultLoginFailureMessage = intl.formatMessage({
        id: 'pages.login.failure',
        defaultMessage: '登录失败，请重试！',
      });
      console.log(error);
      message.error(defaultLoginFailureMessage);
    }
  };
```



修改完毕之后，在登录即可跳转页面‘



> 刷新页面，跳转登录页的问题，修改这个方法

<img src="文档.assets/image-20230508162737206.png" alt="image-20230508162737206" style="zoom:80%;" />



> 这两个方法，这样写可行

<img src="文档.assets/image-20230508162932090.png" alt="image-20230508162932090" style="zoom:80%;" />







### Antd 处理角色问题

<img src="文档.assets/image-20230508224400450.png" alt="image-20230508224400450" style="zoom:80%;" />



> 修改代码

```jsx
export default function access(initialState: InitialState | undefined) {
  const {loginUser} = initialState ?? {};

  return {
    canAdmin: loginUser && loginUser.userRole === 'admin',
    canUser: loginUser && loginUser.userRole === 'user',
  };
}
```





### Antd 表格使用









## 项目模块设计分析



### 接口信息表

id

name 接口名称

description 描述

url 接口地址

type 请求类型

requestHeader 请求头

responseHeader 响应头

status 接口状态 （0 关闭  1 开启）

 

isDelete 

createTime

updateTime



```sql
-- 接口信息表
create table if not exists interface_info
(
    id             bigint auto_increment comment 'id' primary key,

    name           int comment '接口名称',
    description    varchar(512)                         null comment '接口描述',
    url            varchar(512)                         not null comment '接口地址',
    method         varchar(20)                          not null comment '请求类型',
    requestHeader  text                                 null comment '请求头',
    responseHeader text                                 null comment '响应头',
    status         tinyint(1) default 0                 not null comment '接口状态（0 关闭 1 开启）',


    userId         bigint                               not null comment '创建人id',
    userName       varchar(20)                          not null comment '创建人姓名',
    createTime     datetime   default CURRENT_TIMESTAMP not null comment '创建时间',
    updateTime     datetime   default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment '更新时间',
    isDelete       tinyint    default 0                 not null comment '是否删除'
) comment '接口信息表';
```



### 接口后端代码 - controller



```java
/**
 * 接口请求类型
 */
@RestController
@RequestMapping("/interfaceInfo")
@Slf4j
@Api(tags = "接口请求管理")
public class InterFaceInfoController {

    @Resource
    private InterfaceinfoService interfaceInfoService;


    @Resource
    private UserService userService;

    // region 增删改查

    /**
     * 创建
     */
    @PostMapping("/add")
    public BaseResponse<Long> addInterfaceInfo(@Validated @RequestBody InterfaceInfoAddRequest addRequest, HttpServletRequest request) {

        interfaceInfoService.add(addRequest, request);

        return ResultUtils.success();
    }

    /**
     * 删除
     */
    @PostMapping("/delete")
    public BaseResponse<Boolean> deleteInterfaceInfo(@RequestBody DeleteRequest deleteRequest, HttpServletRequest request) {
        if (deleteRequest == null || deleteRequest.getId() <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        User user = userService.getLoginUser(request);
        long id = deleteRequest.getId();
        // 判断是否存在
        InterfaceInfo oldInterfaceInfo = interfaceInfoService.getById(id);
        ThrowUtils.throwIf(oldInterfaceInfo == null, ErrorCode.NOT_FOUND_ERROR);
        // 仅本人或管理员可删除
        if (!oldInterfaceInfo.getUserId().equals(user.getId()) && !userService.isAdmin(request)) {
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
        }
        boolean b = interfaceInfoService.removeById(id);
        return ResultUtils.success(b);
    }

    /**
     * 更新（仅管理员）
     */
    @PostMapping("/update")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Boolean> updateInterfaceInfo(@Validated @RequestBody InterfaceInfoUpdateRequest interfaceInfoUpdateRequest) {
        if (interfaceInfoUpdateRequest == null || interfaceInfoUpdateRequest.getId() <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        Boolean result = interfaceInfoService.upt(interfaceInfoUpdateRequest);

        return ResultUtils.success(result);
    }

    /**
     * 根据 id 获取
     */
    @GetMapping("/get/vo")
    public BaseResponse<InterfaceInfoVo> getInterfaceInfoVOById(long id, HttpServletRequest request) {
        if (id <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        InterfaceInfo interfaceInfo = interfaceInfoService.getById(id);
        if (interfaceInfo == null) {
            throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);
        }
        InterfaceInfoVo interfaceInfoVo = BeanCopyUtil.copyBean(interfaceInfo, InterfaceInfoVo.class);
        return ResultUtils.success(interfaceInfoVo);
    }

    /**
     * 分页获取列表（封装类）
     */
    @PostMapping("/list/page/vo")
    public BaseResponse<PageVo> listInterfaceInfoVOByPage(@RequestBody InterfaceInfoQueryRequest dto) {
        // 限制爬虫
        ThrowUtils.throwIf(dto.getPageSize() > 20, ErrorCode.PARAMS_ERROR);

        Page<InterfaceInfo> pageInfo = interfaceInfoService.selectPage(dto);

        PageVo pageVo = new PageVo();
        pageVo.setCurrent(pageInfo.getCurrent());
        pageVo.setSize(pageInfo.getSize());
        pageVo.setReconds(pageInfo.getRecords());
        pageVo.setTotal(pageInfo.getTotal());

        return ResultUtils.success(pageVo);
    }

}

```



### 前端对接后端的代码 - openApi 生成

























## 需求分析

1. 管理员可以对接口信息进行增删改查
2. 用户可以访问前台，查看接口信息







## 业务流程









## 需求分析



## 项目脚手架



## 基础功能



## 总结